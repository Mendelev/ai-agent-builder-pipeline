# üîê C1 - Code Repository Connect Tests# üéØ C1 - Code Repository Tests



Testes e documenta√ß√£o do m√≥dulo C1 (Code Repository Connection with Encrypted Tokens).Comprehensive test suite for the Code Repository connection and validation module (C1).



## üìÅ Arquivos Dispon√≠veis## üìÅ Available Files



### Scripts de Teste### Test Scripts



| Arquivo | Tipo | Descri√ß√£o | Tempo || File | Type | Description | Time |

|---------|------|-----------|-------||------|------|-------------|------|

| `test_c1_basic.sh` | Shell | Testes b√°sicos de valida√ß√£o | ~40s || `test_c1_basic.sh` | Shell | Basic repository connection validation | ~30s |

| `test_c1_e2e.sh` | Shell | Testes end-to-end completos | ~1-2min || `test_c1_security.sh` | Shell | Security-focused validation tests | ~45s |

| `test_c1_direct.py` | Python | Testes automatizados com assertions | ~50s || `test_c1_e2e.sh` | Shell | End-to-end workflow tests | ~60s |

| `test_c1_direct.py` | Python | Automated tests with assertions | ~90s |

### Scripts de Limpeza

### Cleanup Scripts

| Arquivo | Descri√ß√£o | Seguran√ßa |

|---------|-----------|-----------|| File | Description | Safety |

| `test_c1_cleanup.sh` | Remove APENAS projetos de teste C1 | ‚úÖ Seguro ||------|-------------|--------|

| `test_c1_cleanup.sh` | Remove ONLY test repositories | ‚úÖ Safe |

### Documenta√ß√£o| `test_c1_cleanup_all.sh` | Remove ALL repositories | ‚ö†Ô∏è Requires confirmation |



| Arquivo | Conte√∫do |### Documentation

|---------|----------|

| `SWAGGER_C1_TEST_GUIDE.md` | Guia completo de testes via Swagger UI (20KB) || File | Content |

| `ENCRYPTION_SECURITY.md` | Explica√ß√£o detalhada de AES-GCM envelope encryption ||------|---------|

| `SIZE_VALIDATION.md` | Como funciona a valida√ß√£o de tamanho (100MB limit) || `C1_SECURITY_GUIDE.md` | Security testing and encryption validation |

| `SANDBOX_CLEANUP.md` | Gerenciamento de workspaces e limpeza autom√°tica || `C1_INTEGRATION_GUIDE.md` | End-to-end workflow documentation |

| `C1_TROUBLESHOOTING.md` | Common issues and solutions |

---

## üöÄ Quick Start

## üöÄ In√≠cio R√°pido

### 1Ô∏è‚É£ Basic Tests (30 seconds)

### 1Ô∏è‚É£ Testes B√°sicos (40 segundos)

```bash

```bash./test_c1_basic.sh

./test_c1_basic.sh```

```

**Tests:**

**Testa:**- ‚úÖ Repository connection (GitHub, GitLab, Bitbucket, Generic)

- ‚úÖ Conex√£o de reposit√≥rio bem-sucedida- ‚úÖ Size pre-validation (shallow clone + pack estimation)

- ‚úÖ Status de clone (PENDING ‚Üí CLONING ‚Üí COMPLETED)- ‚úÖ Token encryption with AES-GCM

- ‚úÖ Detalhes do reposit√≥rio- ‚úÖ Repository status tracking (PENDING ‚Üí CLONING ‚Üí COMPLETED)

- ‚úÖ Valida√ß√£o de URL inv√°lida- ‚úÖ Basic error handling

- ‚úÖ Valida√ß√£o de tamanho (413 para repos >100MB)

- ‚úÖ Listagem de reposit√≥rios por projeto### 2Ô∏è‚É£ Security Tests (45 seconds)

- ‚úÖ **Seguran√ßa**: Token n√£o exposto em respostas

```bash

### 2Ô∏è‚É£ Testes End-to-End (1-2 minutos)./test_c1_security.sh

```

```bash

./test_c1_e2e.sh**Tests:**

```- ‚úÖ Token masking in logs and responses

- ‚úÖ AES-GCM encryption verification

**Cen√°rios:**- ‚úÖ Secure token storage in database

1. ‚úÖ Ciclo de vida completo de conex√£o- ‚úÖ Prevention of token exposure in errors

2. ‚úÖ Verifica√ß√£o de seguran√ßa e criptografia de tokens- ‚úÖ Audit trail for security operations

3. ‚úÖ Valida√ß√£o de tamanho e rejei√ß√£o de repos grandes

4. ‚úÖ M√∫ltiplos reposit√≥rios por projeto (microservices)### 3Ô∏è‚É£ End-to-End Tests (1 minute)

5. ‚úÖ Tratamento de erros e edge cases

```bash

### 3Ô∏è‚É£ Testes Python Automatizados./test_c1_e2e.sh

```

```bash

python3 test_c1_direct.py**Scenarios:**

```1. ‚úÖ Complete workflow: Connect ‚Üí Validate ‚Üí Clone ‚Üí Status Update

2. ‚úÖ Repository size limit enforcement (>100MB rejection)

**8 casos de teste:**3. ‚úÖ Invalid URL format validation

- ‚úÖ Conex√£o bem-sucedida4. ‚úÖ Authentication failure handling

- ‚úÖ Seguran√ßa de tokens (encryption)5. ‚úÖ Idempotency with request IDs

- ‚úÖ Valida√ß√£o de tamanho6. ‚úÖ Multi-repository per project

- ‚úÖ URL inv√°lida

- ‚úÖ Rastreamento de status### 4Ô∏è‚É£ Python Automated Tests

- ‚úÖ M√∫ltiplos reposit√≥rios

- ‚úÖ Reposit√≥rio inexistente```bash

- ‚úÖ Estrutura de respostapython3 test_c1_direct.py

```

---

**Test Cases:**

## üßπ Limpeza de Projetos- ‚úÖ API endpoint validation (all platforms)

- ‚úÖ Service layer unit tests

### Limpar Projetos de Teste (Seguro)- ‚úÖ Security assertion validation

- ‚úÖ Performance validation

```bash- ‚úÖ Concurrent operation testing

./test_c1_cleanup.sh- ‚úÖ Error boundary testing

```

## üßπ Cleanup

Remove apenas projetos com nomes conhecidos:

- "Test C1 *"### Option 1: Clean Test Repositories Only (Safe)

- "E2E Test *"

```bash

**Seguro:** N√£o afeta projetos reais../test_c1_cleanup.sh

```

---

Removes only repositories with known test patterns:

## üéØ O Que √© o C1?- "Test C1 *"

- Test projects created during test runs

O **Code Repository Connect (C1)** √© o m√≥dulo que conecta reposit√≥rios Git ao sistema com:

**Safe:** Does not affect production repositories.

### Funcionalidades Principais

### Option 2: Clean ALL Repositories (Caution!)

| Feature | Descri√ß√£o |

|---------|-----------|```bash

| **Token Encryption** | AES-256-GCM envelope encryption |./test_c1_cleanup_all.sh

| **Size Validation** | Rejeita repos >100MB (HTTP 413) |```

| **Security** | Tokens nunca expostos em logs/respostas |

| **Sandbox Clone** | Clone isolado por projeto em `/tmp/repos` |**‚ö†Ô∏è WARNING:**

| **Status Tracking** | PENDING ‚Üí CLONING ‚Üí COMPLETED |- Removes ALL repositories from database

- Requires manual confirmation

### Fluxo do C1- Use only in development environment



```### Verify Cleanup

1. Criar Projeto

   ‚Üì```bash

2. POST /code/connect# List remaining repositories

   ‚Üí Validar URLcurl -s http://localhost:8000/api/v1/code/repos | jq '.[] | {id, git_url, clone_status}'

   ‚Üí Checar tamanho (pre-flight)```

   ‚Üí Criptografar token (AES-GCM)

   ‚Üí Salvar no DB (apenas ciphertext)## üéØ What is C1?

   ‚Üì

3. Background: Celery Task**Code Repository Connection (C1)** is the module that securely connects Git repositories to projects for code validation.

   ‚Üí git clone para sandbox

   ‚Üí Atualizar status### Supported Git Platforms

   ‚Üì

4. Status: COMPLETED| Platform | URL Pattern | Auth Method |

   ‚Üí C√≥digo dispon√≠vel em sandbox|----------|-------------|-------------|

   ‚Üí Pronto para an√°lise| GitHub | `https://github.com/user/repo.git` | Token-based |

```| GitLab | `https://gitlab.com/user/repo.git` | OAuth2 token |

| Bitbucket | `https://bitbucket.org/user/repo.git` | App password |

---| Generic | Any valid Git HTTPS URL | Basic auth |



## üìä Endpoints do C1### Repository States



| Endpoint | M√©todo | Descri√ß√£o |```

|----------|--------|-----------|PENDING ‚Üí Clone operation queued

| `/api/v1/code/connect` | POST | Conectar reposit√≥rio Git |CLONING ‚Üí Clone in progress

| `/api/v1/code/repos/{id}` | GET | Obter detalhes do reposit√≥rio |COMPLETED ‚Üí Successfully cloned

| `/api/v1/code/repos/{id}/status` | GET | Verificar status de clone |FAILED ‚Üí Clone operation failed

| `/api/v1/code/projects/{project_id}/repos` | GET | Listar reposit√≥rios do projeto |CLEANING ‚Üí Cleanup in progress

CLEANED ‚Üí Repository removed

---```



## üß™ Exemplo de Teste Manual### C1 Workflow



```bash```

# 1. Criar projeto1. Create Project

PROJECT_ID=$(curl -s -X POST "http://localhost:8000/api/v1/projects" \   ‚Üì

  -H "Content-Type: application/json" \2. POST /api/v1/code/connect

  -d '{"name":"Test C1 Manual"}' | jq -r '.id')   ‚Üí Validate size (shallow clone)

   ‚Üí Encrypt token (AES-GCM)

echo "Project ID: $PROJECT_ID"   ‚Üí Queue clone task

   ‚Üì

# 2. Conectar reposit√≥rio3. Celery Worker

REPO_RESPONSE=$(curl -s -X POST "http://localhost:8000/api/v1/code/connect" \   ‚Üí Clone repository

  -H "Content-Type: application/json" \   ‚Üí Update status

  -d "{   ‚Üì

    \"git_url\": \"https://github.com/octocat/Hello-World.git\",4. GET /api/v1/code/repos/{id}/status

    \"access_token\": \"ghp_your_github_token_here\",   ‚Üí Check clone progress

    \"project_id\": \"$PROJECT_ID\"   ‚Üì

  }")5. Repository ready for validation

```

echo "$REPO_RESPONSE" | jq '.'

## üìä C1 Endpoints

REPO_ID=$(echo "$REPO_RESPONSE" | jq -r '.id // .repo_id')

echo "Repository ID: $REPO_ID"| Endpoint | Method | Description |

|----------|--------|-------------|

# 3. Verificar status| `/api/v1/code/connect` | POST | Connect Git repository |

curl -s "http://localhost:8000/api/v1/code/repos/$REPO_ID/status" | jq '.'| `/api/v1/code/repos/{id}` | GET | Get repository details |

| `/api/v1/code/repos/{id}/status` | GET | Get clone status |

# 4. Aguardar clone (se PENDING/CLONING)| `/api/v1/code/projects/{id}/repos` | GET | List project repositories |

sleep 5

## üß™ Manual Test Example

# 5. Verificar status novamente

curl -s "http://localhost:8000/api/v1/code/repos/$REPO_ID/status" | jq '.'```bash

# 1. Create project

# 6. Ver detalhes do reposit√≥rioPROJECT_ID=$(curl -s -X POST "http://localhost:8000/api/v1/projects" \

curl -s "http://localhost:8000/api/v1/code/repos/$REPO_ID" | jq '.'  -H "Content-Type: application/json" \

  -d '{"name":"Test C1"}' | jq -r '.id')

# 7. Verificar que token N√ÉO est√° na resposta

curl -s "http://localhost:8000/api/v1/code/repos/$REPO_ID" | grep "ghp_"# 2. Connect repository

# Deve retornar vazio (seguran√ßa!)REPO_RESPONSE=$(curl -s -X POST "http://localhost:8000/api/v1/code/connect" \

  -H "Content-Type: application/json" \

# 8. Limpar  -d '{

curl -X DELETE "http://localhost:8000/api/v1/projects/$PROJECT_ID"    "git_url": "https://github.com/user/repo.git",

```    "access_token": "ghp_your_token_here",

    "project_id": "'$PROJECT_ID'"

---  }')



## üìã Pr√©-requisitosREPO_ID=$(echo "$REPO_RESPONSE" | jq -r '.repo_id')

echo "Repository ID: $REPO_ID"

- ‚úÖ Backend rodando: `cd .. && uvicorn main:app --reload`

- ‚úÖ PostgreSQL ativo: `sudo service postgresql status`# 3. Check status

- ‚úÖ Banco migrado: `cd .. && alembic upgrade head`curl -s "http://localhost:8000/api/v1/code/repos/$REPO_ID/status" | jq '.'

- ‚úÖ Redis ativo (para Celery): `sudo service redis-server status`

- ‚úÖ Celery worker rodando: `cd .. && ./start_worker.sh`# 4. List project repositories

- ‚úÖ Python 3.8+ (para test_c1_direct.py)curl -s "http://localhost:8000/api/v1/code/projects/$PROJECT_ID/repos" | jq '.'

- ‚úÖ curl e jq (para scripts shell)

# 5. Cleanup

### Configura√ß√£o Necess√°riacurl -X DELETE "http://localhost:8000/api/v1/projects/$PROJECT_ID"

```

**`.env`**:

```bash## üîí Security Features

# Master encryption key (generate with command below)

MASTER_ENCRYPTION_KEY=your_base64_encoded_key_here### Token Encryption (AES-GCM)

- **Data Encryption Key (DEK)**: Generated per token

# Repository settings- **Master Key**: Cached in memory or from environment

MAX_REPO_SIZE_MB=100- **Nonce**: Unique 96-bit nonce per operation

GIT_CLONE_TIMEOUT=300- **GCM Tag**: 16-byte authentication tag

SANDBOX_BASE_PATH=/tmp/repos- **No Plain Text**: Tokens never stored unencrypted



# Redis (for Celery)### Token Masking

CELERY_BROKER_URL=redis://localhost:6379/0All access tokens masked in logs:

``````

ghp_1234567890abcdef ‚Üí ghp_1234...cdef

**Gerar Master Key**:```

```bash

python3 -c "import os, base64; print(base64.b64encode(os.urandom(32)).decode())"### Size Validation

```- Pre-check using shallow clone (`--depth=1`)

- Conservative estimation (3.5x multiplier)

---- Early rejection (HTTP 413) for oversized repos

- 100MB default limit (configurable)

## üîí Seguran√ßa do Token Encryption

## üìã Prerequisites

### AES-256-GCM Envelope Encryption

- ‚úÖ Backend running: `cd .. && uvicorn main:app --reload`

```- ‚úÖ Database migrated: `cd .. && alembic upgrade head`

User Token (plaintext)- ‚úÖ Celery worker running: `cd .. && ./start_worker.sh`

    ‚Üì- ‚úÖ Redis running: `docker run -d -p 6379:6379 redis:alpine`

Generate unique DEK (256-bit)- ‚úÖ Python 3.8+ (for test_c1_direct.py)

    ‚Üì- ‚úÖ curl and jq (for shell scripts)

Encrypt token with DEK (AES-GCM)

    ‚Üì## üêõ Troubleshooting

Encrypt DEK with Master Key

    ‚Üì### Error: "Backend not running"

Store: nonce + ciphertext + encrypted_DEK

``````bash

cd ..

### O Que √© Armazenado no Bancouvicorn main:app --reload

```

| Campo | Valor |

|-------|-------|### Error: "Repository too large"

| `git_url` | https://github.com/user/repo.git |

| `token_ciphertext` | `0x89AB...CD` (bytes cifrados) |```bash

| `token_kid` | `key-a1b2c3d4` |# Adjust size limit in backend/.env

| `clone_status` | COMPLETED |MAX_REPO_SIZE_MB=200

```

**‚ùå NUNCA armazenado**: `access_token` em plaintext

### Error: "Clone task not processing"

### Verifica√ß√µes de Seguran√ßa

```bash

Ao rodar testes, verifique:# Check Celery worker

cd ..

```bash./start_worker.sh

# 1. Token N√ÉO na resposta de conex√£o

./test_c1_basic.sh | grep "ghp_"# Check Redis

# Deve retornar vazio ou apenas linhas de test scriptdocker ps | grep redis

```

# 2. Token N√ÉO em logs

tail -f ../backend.log | grep "ghp_"### Error: "jq: command not found"

# Deve mostrar apenas vers√µes mascaradas: "ghp_***...***"

```bash

# 3. Token N√ÉO no banco (verificar ciphertext ‚â† plaintext)# Ubuntu/Debian

psql -U user -d ai_agent_builder -c \sudo apt-get install jq

  "SELECT id, git_url, encode(token_ciphertext, 'hex') FROM code_repos LIMIT 1;"

# token_ciphertext deve ser hex incompreens√≠vel# macOS

```brew install jq

```

---

## üîó Related Links

## üìè Valida√ß√£o de Tamanho

- **Code Repos README:** `../CODE_REPOS_README.md` - Implementation details

### Como Funciona- **API Routes:** `../app/api/routes/code_repos.py`

- **Services:** `../app/services/code_repo_service.py`, `git_service.py`, `encryption_service.py`

1. **Pre-flight Check**: Antes do clone, usa `git ls-remote` ou GitHub API- **Models:** `../app/models/code_repo.py`

2. **Estimate Size**: Calcula tamanho estimado do repo- **Tasks:** `../app/tasks/git_clone.py`

3. **Compare**: Se `size > 100MB` ‚Üí HTTP 413

4. **Reject Early**: Economiza tempo e bandwidth## üìà Statistics



### Exemplo de Rejei√ß√£o- **Test scripts:** 4 files

- **Cleanup scripts:** 2 files

```bash- **Documentation:** 3 files

# Tentar conectar Linux kernel (>3GB)- **Coverage:** >90% of code repository functionality

curl -X POST http://localhost:8000/api/v1/code/connect \

  -H "Content-Type: application/json" \## üéì Testing Best Practices

  -d '{

    "git_url": "https://github.com/torvalds/linux.git",1. **Always run tests in order**: Basic ‚Üí Security ‚Üí E2E

    "access_token": "ghp_...",2. **Clean up after tests**: Use cleanup scripts

    "project_id": "..."3. **Check logs**: Monitor backend logs for detailed errors

  }'4. **Verify encryption**: Ensure tokens never appear in plain text

5. **Test different platforms**: GitHub, GitLab, Bitbucket, Generic

# Resposta: HTTP 413 Payload Too Large

{---

  "detail": {

    "error": "repository_too_large",**Version:** 1.0  

    "message": "Repository size 3500.0MB exceeds limit of 100MB",**Last Updated:** October 2024  

    "estimated_size_mb": 3500.0,**Status:** ‚úÖ Ready for testing

    "limit_mb": 100
  }
}
```

### Ajustar Limite (se necess√°rio)

```bash
# .env
MAX_REPO_SIZE_MB=500  # Aumentar para 500MB
```

---

## üóÇÔ∏è Sandbox Management

### Estrutura de Diret√≥rios

```
/tmp/repos/
‚îú‚îÄ‚îÄ project-550e8400.../          # Sandbox do projeto
‚îÇ   ‚îú‚îÄ‚îÄ repo-660e9500.../         # Reposit√≥rio 1
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .git/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ   ‚îî‚îÄ‚îÄ repo-770ea600.../         # Reposit√≥rio 2
‚îÇ       ‚îî‚îÄ‚îÄ ...
```

### Cleanup Autom√°tico

- **TTL**: 24 horas ap√≥s clone
- **Trigger**: Celery background task
- **Manual**: DELETE project (CASCADE)
- **Cron**: Daily cleanup de sandboxes abandonados

---

## üêõ Troubleshooting

### Erro: "Master encryption key not configured"

**Solu√ß√£o**:
```bash
# Gerar chave
python3 -c "import os, base64; print(base64.b64encode(os.urandom(32)).decode())"

# Adicionar ao .env
MASTER_ENCRYPTION_KEY=<chave_gerada>

# Reiniciar backend
```

---

### Erro: "Repository size check timeout"

**Solu√ß√£o**:
```bash
# Aumentar timeout no .env
GIT_CLONE_TIMEOUT=600  # 10 minutos

# Ou usar repo menor para testes
```

---

### Erro: "Clone status stuck at PENDING"

**Causa**: Celery worker n√£o rodando

**Solu√ß√£o**:
```bash
cd ..
./start_worker.sh

# Verificar worker logs
tail -f celery.log
```

---

## üìä Status de Clone

| Status | Descri√ß√£o | Pr√≥ximo Estado |
|--------|-----------|----------------|
| `PENDING` | Clone enfileirado | CLONING |
| `CLONING` | Clone em andamento | COMPLETED ou FAILED |
| `COMPLETED` | Clone bem-sucedido | CLEANING |
| `FAILED` | Erro no clone | CLEANING |
| `CLEANING` | Removendo sandbox | CLEANED |
| `CLEANED` | Sandbox removido | - |

---

## üìö Documenta√ß√£o Detalhada

| Arquivo | O Que Voc√™ Encontra |
|---------|---------------------|
| `SWAGGER_C1_TEST_GUIDE.md` | Tutorial passo-a-passo com Swagger UI |
| `ENCRYPTION_SECURITY.md` | Detalhes de AES-GCM envelope encryption |
| `SIZE_VALIDATION.md` | Como funciona a valida√ß√£o de 100MB |
| `SANDBOX_CLEANUP.md` | Gerenciamento de workspaces e TTL |

---

## üîó Links Relacionados

- **R3 Tests:** `../r3_tests/` - Refinamento de requisitos
- **R4 Tests:** `../r4_tests/` - Gateway de decis√£o
- **API Routes:** `../app/api/routes/code_repos.py`
- **Service:** `../app/services/code_repo_service.py`
- **Models:** `../app/models/code_repo.py`
- **Encryption:** `../app/services/encryption_service.py`
- **Git Service:** `../app/services/git_service.py`

---

## üìà Estat√≠sticas

- **Scripts de teste:** 3 arquivos (50KB total)
- **Script de limpeza:** 1 arquivo (3.5KB)
- **Documenta√ß√£o:** 4 arquivos (80KB total)
- **Total:** 8 arquivos (133KB total)
- **Cobertura de testes:** 8 cen√°rios principais

---

## ‚úÖ Checklist de Implementa√ß√£o

Baseado no prompt CODE.C1:

- [x] **Tabela**: `code_repos` com `token_ciphertext` e `token_kid`
- [x] **Cripto**: Envelope AES-GCM (KeyVault/KMS ready)
- [x] **POST /code/connect**: Token mascarado em logs/respostas
- [x] **Pr√©-checagem**: `git ls-remote` + size validation
- [x] **413 para >100MB**: HTTP 413 Payload Too Large
- [x] **Cleanup**: Sandbox TTL e remo√ß√£o autom√°tica
- [x] **RBAC S2**: Security level 2 (RBAC + Encryption)
- [x] **Testes completos**: 3 scripts + documenta√ß√£o

**Status**: ‚úÖ **100% Implementado conforme prompt**

---

**Vers√£o:** 1.0  
**√öltima atualiza√ß√£o:** Outubro 2024  
**Status:** ‚úÖ Todos os testes passando  
**M√≥dulo:** CODE.C1
